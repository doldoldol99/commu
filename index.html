<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ë§Œì˜ íŠ¸ìœ„í„°</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* ==========================================
           [ğŸ¨ ë””ìì¸ í…Œë§ˆ (v25 ê¸°ë°˜)]
           ========================================== */
        :root {
            --bg-main: #121212; --bg-card: #1E1E1E; --bg-sub: #2C2C2C;
            --text-main: #E0E0E0; --text-sub: #A9A9A9; --border-color: #2C2C2C;
            --point-color: #8FBC8F; --point-color-dim: #556B2F; --point-bg-tint: #2F3B2F;
            --danger-color: #ff6b6b; --shadow-color: rgba(0,0,0,0.5);
            --link-color: #4da6ff; --thread-line-color: #4a4a4a;
            --nav-icon-color: #FFFFFF;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow-card: 0 4px 6px var(--shadow-color);
            --border-radius-card: 20px; --border-radius-btn: 9999px;
        }

        [data-theme="light"] {
            --bg-main: #F5F7F5; --bg-card: #FFFFFF; --bg-sub: #E0E0E0;
            --text-main: #2F3B2F; --text-sub: #666666; --border-color: #E0E0E0;
            --point-color: #697644; --point-color-dim: #8FBC8F; --point-bg-tint: #E8F5E9;
            --shadow-color: rgba(0,0,0,0.1); --link-color: #0066cc; --thread-line-color: #d0d0d0;
            --nav-icon-color: #000000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-main); padding-bottom: 80px; color: var(--text-main); transition: background 0.3s, color 0.3s; }
        button { font-family: var(--font-main); cursor: pointer; }
        a { color: var(--point-color); text-decoration: none; }
        .link-text { color: var(--link-color); text-decoration: underline; cursor: pointer; word-break: break-all; }
        .mention-tag { color: var(--point-color); font-weight: bold; background: var(--point-bg-tint); padding: 2px 6px; border-radius: 6px; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        #image-modal { background-color: rgba(0,0,0,0.95); flex-direction: column; }
        .modal-content-img { max-width: 100%; max-height: 80vh; object-fit: contain; }
        .close-modal-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 5002; background: rgba(0,0,0,0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .modal-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); color: white; font-size: 40px; cursor: pointer; z-index: 5001; padding: 20px; opacity: 0.7; background: none; border: none; }
        .prev-btn { left: 10px; } .next-btn { right: 10px; }
        .modal-counter { position: absolute; bottom: 30px; color: white; background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px; }

        /* í—¤ë” */
        .header { position: sticky; top: 0; z-index: 100; background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 16px 20px; margin: 10px auto; border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); transition: background 0.3s; max-width: 600px; }
        [data-theme="light"] .header { background: rgba(255, 255, 255, 0.95); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-weight: 800; font-size: 22px; color: var(--text-main); }

        #user-menu-dropdown { display: none; position: absolute; top: 70px; right: 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-card); z-index: 200; width: 180px; overflow: hidden; }
        .menu-item { padding: 12px 16px; cursor: pointer; color: var(--text-main); font-size: 15px; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .menu-item:hover { background-color: var(--bg-sub); }
        .menu-item.danger { color: var(--danger-color); }

        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        
        .tweet-input-box { background: var(--bg-card); padding: 16px; margin: 10px; border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); position: relative; }
        textarea { width: 100%; height: 80px; border: 1px solid var(--border-color); resize: none; font-size: 16px; outline: none; margin-bottom: 10px; padding: 12px; border-radius: 12px; background: var(--bg-main); color: var(--text-main); transition: background 0.3s; }
        textarea:focus { border-color: var(--point-color); }
        .tweet-btn { background-color: var(--point-color); color: var(--bg-main); border: none; padding: 10px 20px; border-radius: var(--border-radius-btn); font-weight: 700; font-size: 15px; cursor: pointer; transition: background 0.2s; }
        .tweet-btn:hover { opacity: 0.9; }
        .tweet-btn:disabled { background-color: var(--bg-sub); color: var(--text-sub); cursor: not-allowed; }
        .char-counter { font-size: 12px; color: var(--text-sub); margin-right: 10px; }
        .char-counter.warning { color: var(--danger-color); font-weight: bold; }

        .full-btn { width: 100%; padding: 12px; border-radius: var(--border-radius-btn); border: none; cursor: pointer; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        .btn-blue { background: var(--point-color); color: var(--bg-main); }
        .btn-gray { background: var(--bg-sub); color: var(--text-main); }
        .btn-danger { background: var(--bg-sub); color: var(--danger-color); border: 1px solid var(--danger-color); }
        .btn-danger:hover { background: var(--danger-color); color: white; }

        .feed { padding: 0 10px; }
        
        /* íƒ€ë˜ ë””ìì¸ (v25) */
        .thread-group { background: var(--bg-card); margin-bottom: 12px; border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); overflow: hidden; border: 1px solid var(--border-color); }
        .thread-group .tweet { margin-bottom: 0; border-bottom: none; border-radius: 0; }
        .thread-group .tweet:last-child { border-bottom: none; }
        .tweet { background: var(--bg-card); padding: 16px; display: flex; gap: 12px; position: relative; cursor: pointer; transition: background 0.1s; z-index: 1; }
        .tweet.single { margin-bottom: 12px; border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); border: 1px solid var(--border-color); }
        .tweet-left { display: flex; flex-direction: column; align-items: center; width: 48px; flex-shrink: 0; position: relative; }
        /* ì—°ê²°ì„  */
        .thread-line-up { position: absolute; top: -16px; bottom: 50%; left: 50%; transform: translateX(-50%); width: 2px; background-color: var(--thread-line-color); z-index: 0; display: none; }
        .thread-line-down { position: absolute; top: 50%; bottom: -16px; left: 50%; transform: translateX(-50%); width: 2px; background-color: var(--thread-line-color); z-index: 0; display: none; }
        .tweet.has-parent .thread-line-up { display: block; }
        .tweet.has-child .thread-line-down { display: block; }
        .profile-pic { width: 48px; height: 48px; background-color: var(--bg-sub); border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); z-index: 2; position: relative; }
        .content { width: 100%; }
        .content h4 { margin-bottom: 4px; font-size: 16px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 6px; flex-wrap: wrap;}
        .user-handle { font-weight: normal; color: var(--text-sub); font-size: 14px; }
        .content p { font-size: 15px; line-height: 1.5; color: var(--text-main); white-space: pre-wrap; word-break: break-word; }
        .content .time { color: var(--text-sub); font-size: 14px; font-weight: normal; }
        .tweet.focus-tweet { background: var(--bg-card); border: 2px solid var(--point-color); border-radius: 12px; margin: 5px 0; }
        .tweet.focus-tweet .content p { font-size: 18px; line-height: 1.6; }
        .reply-indicator { font-size: 13px; color: var(--text-sub); margin-bottom: 6px; display: block; }
        .reply-indicator span { color: var(--point-color); font-weight: bold; }
        .tweet-actions { display: flex; gap: 20px; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .action-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: color 0.2s; }
        .action-btn.active-keep { color: var(--point-color); font-weight: bold; }
        .action-btn:hover { color: var(--point-color); }
        .load-more-thread-btn { width: 100%; padding: 12px; background: var(--bg-card); color: var(--point-color); border: none; border-top: 1px solid var(--border-color); cursor: pointer; font-weight: bold; font-size: 14px; }
        .hidden-thread-item { display: none; }
        
        .tweet-img-grid { display: grid; gap: 2px; margin-top: 12px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); width: 100%; }
        .tweet-img-item { width: 100%; height: 100%; object-fit: cover; cursor: pointer; background: var(--bg-sub); }
        .grid-1 { grid-template-columns: 1fr; } .grid-1 .tweet-img-item { aspect-ratio: 16/9; max-height: 400px; }
        .grid-2 { grid-template-columns: 1fr 1fr; aspect-ratio: 16/9; }
        .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; aspect-ratio: 16/9; }
        .grid-3 img:first-child { grid-row: span 2; height: 100%; }
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; aspect-ratio: 16/9; }
        .delete-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-sub); cursor: pointer; font-size: 18px; padding: 4px; z-index: 10; }
        .delete-btn:hover { color: var(--danger-color); }
        
        /* í”„ë¡œí•„ ë“± */
        .profile-header { background: var(--bg-card); padding: 30px 20px; text-align: center; border-radius: 0 0 var(--border-radius-card) var(--border-radius-card); box-shadow: var(--shadow-card); position: relative; margin: 10px; margin-top: 0; }
        .profile-img-large { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--bg-card); object-fit: cover; background-color: var(--bg-sub); box-shadow: var(--shadow-card); margin-top: -50px; cursor: pointer; }
        .profile-banner { height: 150px; background-color: var(--point-color-dim); border-radius: var(--border-radius-card); margin: 10px; margin-bottom: 0; }
        .profile-name { font-weight: 800; font-size: 22px; margin-top: 10px; color: var(--text-main); }
        .profile-handle { font-size: 15px; color: var(--text-sub); margin-top: 2px; }
        .profile-website { font-size: 14px; margin-top: 6px; }
        .edit-profile-btn { position: absolute; top: 16px; right: 16px; background: var(--bg-card); border: 2px solid var(--point-color); color: var(--point-color); padding: 8px 16px; border-radius: var(--border-radius-btn); font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .edit-profile-btn:hover { background: var(--point-color); color: var(--bg-main); }
        .profile-tabs { display: flex; background: var(--bg-card); border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); margin: 10px; overflow: hidden; border: 1px solid var(--border-color); }
        .tab-item { flex: 1; text-align: center; padding: 16px; cursor: pointer; font-weight: 700; color: var(--text-sub); transition: all 0.2s; position: relative; }
        .tab-item.active { color: var(--point-color); }
        .tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 4px; background: var(--point-color); border-radius: 4px 4px 0 0; }
        .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; display: none; border-radius: var(--border-radius-card); overflow: hidden; margin: 10px; border: 1px solid var(--border-color); }
        .media-item { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; transition: opacity 0.2s; background: var(--bg-sub); }

        #dm-user-list, #explore-user-list, #admin-user-list { padding: 10px; }
        .user-list-item { background: var(--bg-card); padding: 16px; margin-bottom: 10px; border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); display: flex; align-items: center; justify-content: space-between; cursor: pointer; border: 1px solid var(--border-color); }
        .user-list-img { width: 50px; height: 50px; border-radius: 50%; background: var(--bg-sub); object-fit: cover; margin-right: 12px; border: 2px solid var(--bg-main); }
        .list-badge { background: var(--danger-color); color: var(--text-main); border-radius: 50%; padding: 6px 10px; font-size: 12px; font-weight: 700; display: none; }
        #chat-room { display: none; background: var(--bg-main); position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; z-index: 2000; flex-direction: column; }
        .chat-header { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--bg-sub); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
        [data-theme="light"] .chat-header { background: rgba(255, 255, 255, 0.95); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; word-wrap: break-word; box-shadow: var(--shadow-card); }
        .msg-mine { align-self: flex-end; background-color: var(--point-color); color: var(--bg-main); border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background-color: var(--bg-card); color: var(--text-main); border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }
        .chat-input-area { padding: 12px 16px; padding-bottom: 30px; background: var(--bg-card); border-top: 1px solid var(--border-color); display: flex; gap: 12px; align-items: center; }
        .chat-input { flex: 1; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--border-radius-btn); outline: none; font-size: 15px; background: var(--bg-main); color: var(--text-main); }
        .send-btn-icon { background: none; border: none; color: var(--point-color); font-size: 24px; cursor: pointer; padding: 4px; }
        .leave-chat-btn { background: none; border: none; color: var(--danger-color); font-size: 14px; font-weight: bold; cursor: pointer; }

        .notification-item { background: var(--bg-card); padding: 16px; margin-bottom: 10px; border-radius: var(--border-radius-card); border: 1px solid var(--border-color); display: flex; gap: 12px; cursor: pointer; align-items: flex-start; transition: background-color 0.2s; box-shadow: var(--shadow-card); }
        .notification-item:hover { background-color: var(--bg-sub); }
        .notification-item.unread { background: var(--point-bg-tint); border-left: 4px solid var(--point-color); }
        .noti-icon { font-size: 20px; color: var(--point-color); margin-top: 2px; }
        .noti-preview { font-size: 13px; color: var(--text-sub); margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70vw; }

        .bottom-nav { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 600px; background-color: var(--point-color); border: none; display: flex; justify-content: space-around; padding: 14px 0; z-index: 1000; border-radius: var(--border-radius-btn); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .nav-item { font-size: 28px; cursor: pointer; position: relative; color: var(--nav-icon-color); transition: opacity 0.2s; display: flex; align-items: center; opacity: 0.6; }
        .nav-item:hover, .nav-item.active { opacity: 1; color: var(--nav-icon-color); }
        .nav-badge { position: absolute; top: -4px; right: -6px; background: var(--danger-color); color: white; border-radius: 50%; min-width: 18px; height: 18px; padding: 0 4px; font-size: 11px; line-height: 18px; text-align: center; font-weight: 700; border: 2px solid var(--point-color); display: none; }

        #auth-form, #edit-profile-form, #reply-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: var(--bg-card); padding: 24px; border-radius: var(--border-radius-card); box-shadow: var(--shadow-card); z-index: 3000; border: 1px solid var(--border-color); }
        .auth-title { font-weight: 800; font-size: 22px; margin-bottom: 20px; text-align: center; color: var(--text-main); }
        .auth-input { width: 100%; margin-bottom: 12px; padding: 12px; border: 1px solid var(--bg-sub); border-radius: 12px; font-size: 15px; outline: none; background: var(--bg-main); color: var(--text-main); }
        .auth-input:focus { border-color: var(--point-color); }
        
        #preview-box, #reply-preview-box { display:none; margin: 10px 0; position: relative; }
        .preview-grid { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; max-height: 300px; border: 1px solid var(--border-color); }
        .preview-img { width: 100%; height: 100%; object-fit: cover; background: var(--bg-sub); }
        .remove-img-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: var(--text-main); border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; z-index: 10; }

        .profile-edit-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px; display: block; border: 2px solid var(--bg-main); max-width: 100%; max-height: 200px; }

        #scrollTopBtn { display: none; position: fixed; bottom: 85px; right: 20px; z-index: 900; width: 45px; height: 45px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--point-color); font-size: 24px; cursor: pointer; box-shadow: var(--shadow-card); align-items: center; justify-content: center; }
        @media (min-width: 620px) { #scrollTopBtn { right: calc(50% - 300px + 20px); } }

        #login-guide { display:none; padding:50px 20px; text-align:center; color:var(--text-sub); margin-top:20px; }
        #login-guide h3 { margin-bottom:10px; color:var(--text-main); }

        .hidden-thread-item { display: none; }
        
        /* [NEW] ê´€ë¦¬ì í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        #admin-page { display: none; }
        .approve-btn { background-color: var(--point-color); color: var(--bg-main); border: none; padding: 6px 12px; border-radius: 999px; font-weight: bold; cursor: pointer; font-size:13px; margin-left:10px; }
        .approve-btn:hover { opacity:0.9; }
        .delete-user-btn { background-color: var(--bg-sub); color: var(--danger-color); border: 1px solid var(--danger-color); padding: 6px 12px; border-radius: 999px; font-weight: bold; cursor: pointer; font-size:13px; margin-left:6px; }
        .delete-user-btn:hover { background-color: var(--danger-color); color: white; }

    </style>
</head>
<body>
    <div id="image-modal" class="modal-overlay">
        <span class="close-modal-btn" onclick="closeImageModal()">&times;</span>
        <button class="modal-nav-btn prev-btn" onclick="changeImage(-1)">&#10094;</button>
        <img class="modal-content-img" id="modal-img">
        <button class="modal-nav-btn next-btn" onclick="changeImage(1)">&#10095;</button>
        <div class="modal-counter" id="modal-counter"></div>
    </div>

    <button id="scrollTopBtn" onclick="scrollToTop()">â†‘</button>

    <div id="reply-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h4 style="font-size:18px; color:var(--text-main);">ë‹µê¸€ ë‹¬ê¸°</h4>
            <button onclick="closeReplyModal()" style="border:none; background:none; font-size:20px; cursor:pointer; color:var(--text-main);">&times;</button>
        </div>
        <div style="margin-bottom:10px; color:var(--text-sub); font-size:14px;">
            Reply to <span id="reply-target-name" style="color:var(--point-color); font-weight:bold;">@User</span>
        </div>
        <textarea id="replyMsg" placeholder="ë‹µê¸€ì„ ê²Œì‹œí•˜ì„¸ìš”" style="height:100px;"></textarea>
        <div id="reply-preview-box">
            <div id="reply-preview-grid" class="preview-grid grid-1"></div>
            <button onclick="removeReplyImages()" class="remove-img-btn">âœ•</button>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <label for="reply-file-input" style="cursor: pointer; color: var(--point-color); font-size: 22px;">ğŸ“·</label>
            <input type="file" id="reply-file-input" accept="image/*" multiple style="display: none;" onchange="handleReplyFileSelect(this)">
            <button id="replySubmitBtn" class="tweet-btn" onclick="submitReply()">ë‹µê¸€</button>
        </div>
    </div>

    <div id="main-page" class="page active">
        <div class="header">
            <div class="header-content">
                <span class="header-title">ë‚˜ì˜ íŠ¸ìœ„í„°</span>
                <div id="auth-buttons">
                    <button onclick="toggleAuth('login')" class="tweet-btn">ë¡œê·¸ì¸</button>
                    <button onclick="toggleAuth('signup')" class="tweet-btn btn-gray" style="margin-left: 8px;">íšŒì›ê°€ì…</button>
                </div>
                <div id="user-info" style="display:none; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleUserMenu()">
                    <div style="text-align: right;">
                        <span id="userNameDisplay" style="font-size: 15px; font-weight: 700; display: block; color:var(--text-main);"></span>
                        <span id="userHandleDisplay" style="font-size: 12px; color: var(--text-sub); display: block;"></span>
                    </div>
                    <img id="myProfileSmall" src="" class="profile-pic">
                </div>
                <div id="user-menu-dropdown">
                    <div class="menu-item" onclick="goToMyProfile()">ğŸ‘¤ ë‚´ í”„ë¡œí•„</div>
                    <div id="admin-menu-item" class="menu-item" style="display:none; color:var(--point-color);" onclick="goToAdminPage()">ğŸ‘‘ ê´€ë¦¬ì í˜ì´ì§€</div>
                    <div class="menu-item" onclick="toggleTheme()">ğŸŒ“ í…Œë§ˆ ë³€ê²½</div>
                    <div class="menu-item danger" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
                </div>
            </div>
        </div>
        <div class="feed">
            <div class="tweet-input-box" id="tweetInputArea" style="display:none;">
                <textarea id="tweetMsg" maxlength="300" oninput="updateCharCount(this)" placeholder="ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ê³  ìˆë‚˜ìš”? (@ì•„ì´ë”” ë¡œ íƒœê·¸í•´ë³´ì„¸ìš”)"></textarea>
                <div id="preview-box">
                    <div id="preview-grid" class="preview-grid grid-1"></div>
                    <button onclick="removeImages()" class="remove-img-btn">âœ•</button>
                </div>
                <div class="storage-bar-container"><div id="storageBarFill" class="storage-bar-fill"></div></div>
                <div class="storage-text" id="storageTextDetail">ìš©ëŸ‰ ì²´í¬ ì¤‘...</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                    <div style="display:flex; align-items:center;">
                        <label for="file-input" style="cursor: pointer; color: var(--point-color); font-size: 22px; padding: 8px;">ğŸ“·</label>
                        <input type="file" id="file-input" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(this)">
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span id="charCount" class="char-counter">0/300</span>
                        <button id="tweetBtn" class="tweet-btn" onclick="addTweet()">íŠ¸ìœ—í•˜ê¸°</button>
                    </div>
                </div>
            </div>
            <div id="login-guide">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ”’</div>
                <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                <p>ê°€ì…í•˜ê±°ë‚˜ ë¡œê·¸ì¸í•˜ì—¬<br>ì¹œêµ¬ë“¤ì˜ ì†Œì‹ì„ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            </div>
            <div id="tweet-list"></div>
        </div>
    </div>

    <div id="detail-page" class="page">
        <div class="header">
            <div class="header-content" style="justify-content: flex-start; gap: 20px;">
                <button onclick="goToPage('main')" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-main);">â†</button>
                <span class="header-title">íŠ¸ìœ—</span>
            </div>
        </div>
        <div class="feed" id="detail-feed" style="padding-top:10px;"></div>
    </div>

    <div id="noti-page" class="page">
        <div class="header"><div class="header-content"><span class="header-title">ì•Œë¦¼</span></div></div>
        <div id="noti-list" class="feed" style="padding: 10px;"><div style="padding: 30px; text-align: center; color: var(--text-sub);">ë¡œë”© ì¤‘...</div></div>
    </div>

    <div id="profile-page" class="page">
        <div class="profile-banner"></div>
        <div class="profile-header">
            <button id="editProfileBtn" class="edit-profile-btn" onclick="toggleEditProfile()" style="display:none;">í”„ë¡œí•„ ìˆ˜ì •</button>
            <img id="profilePageImg" src="" class="profile-img-large" onclick="openImageModal([this.src], 0)">
            <div id="profilePageName" class="profile-name">ì´ë¦„</div>
            <div id="profilePageHandle" class="profile-handle">@id</div>
            <div id="profilePageBio" class="profile-bio">ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div id="profilePageLink" class="profile-website"></div>
            <div class="profile-stats" style="color:var(--text-main); margin-top:10px;">
                <span><strong id="myTweetCount">0</strong> íŠ¸ìœ—</span>
                <span style="margin-left: 10px;"><strong id="myMediaCount">0</strong> ë¯¸ë””ì–´</span>
            </div>
        </div>
        <div class="profile-tabs">
            <div class="tab-item active" onclick="switchTab('tweets')">íŠ¸ìœ—</div>
            <div class="tab-item" onclick="switchTab('media')">ë¯¸ë””ì–´</div>
            <div class="tab-item" onclick="switchTab('keeps')">Keep</div>
        </div>
        <div class="feed">
            <div id="my-tweet-list"></div>
            <div id="my-media-grid" class="media-grid"></div>
            <div id="my-keep-list" style="display:none;"></div>
        </div>
    </div>

    <div id="dm-page" class="page">
        <div class="header"><div class="header-content"><span class="header-title">ë©”ì‹œì§€</span></div></div>
        <div id="dm-user-list" style="padding: 10px;"><div style="padding: 30px; text-align: center; color: var(--text-sub);">ë¡œë”© ì¤‘...</div></div>
    </div>

    <div id="explore-page" class="page">
        <div class="header"><div class="header-content"><span class="header-title">íƒìƒ‰</span></div></div>
        <div id="explore-user-list" style="padding: 10px;"><div style="padding: 30px; text-align: center; color: var(--text-sub);">ë¡œë”© ì¤‘...</div></div>
    </div>

    <div id="chat-room">
        <div class="chat-header">
            <button class="back-btn" onclick="closeChat()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-main); margin-right:10px;">â†</button>
            <span id="chatTargetName" style="font-weight: 800; font-size: 18px; color:var(--text-main);">ìƒëŒ€ë°©</span>
            <button class="leave-chat-btn" onclick="leaveChat()">ë‚˜ê°€ê¸°</button>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.keyCode==13) sendMsg()">
            <button class="send-btn-icon" onclick="sendMsg()">ğŸ“¤</button>
        </div>
    </div>

    <div id="admin-page" class="page">
        <div class="header"><div class="header-content" style="justify-content: flex-start; gap: 20px;"><button onclick="goToPage('main')" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-main);">â†</button><span class="header-title">íšŒì› ê´€ë¦¬</span></div></div>
        <div id="admin-user-list" style="padding: 10px;"><div style="padding: 30px; text-align: center; color: var(--text-sub);">ë¡œë”© ì¤‘...</div></div>
    </div>

    <div id="auth-form">
        <h4 id="auth-title" class="auth-title">ë¡œê·¸ì¸</h4>
        <input type="text" id="handleInput" class="auth-input" placeholder="ì•„ì´ë”” (ì˜ë¬¸,ìˆ«ì)" style="display:none;" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '').toLowerCase()">
        <input type="text" id="nickNameInput" class="auth-input" placeholder="ë‹‰ë„¤ì„ (ì´ë¦„)" style="display:none;">
        <input type="email" id="emailInput" class="auth-input" placeholder="ì´ë©”ì¼">
        <input type="password" id="pwInput" class="auth-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button id="submitAuthBtn" class="full-btn btn-blue">í™•ì¸</button>
        <button onclick="toggleAuth('close')" class="full-btn btn-gray">ì·¨ì†Œ</button>
    </div>
    
    <div id="edit-profile-form">
        <h4 class="auth-title">í”„ë¡œí•„ ìˆ˜ì •</h4>
        <img id="editProfilePreview" src="" class="profile-edit-preview">
        <label for="profile-file-input" class="file-upload-label" style="display:block; text-align:center; color:var(--point-color); margin-bottom:20px; cursor:pointer;">ğŸ“· ì‚¬ì§„ ë³€ê²½í•˜ê¸°</label>
        <input type="file" id="profile-file-input" accept="image/*" style="display:none;" onchange="handleProfileFileSelect(this)">
        <input type="text" id="editBioInput" class="auth-input" placeholder="ìê¸°ì†Œê°œ (í•œì¤„)">
        <input type="url" id="editLinkInput" class="auth-input" placeholder="ë§í¬ (https://...)">
        <button id="saveProfileBtn" onclick="saveProfile()" class="full-btn btn-blue" style="margin-bottom:10px;">ì €ì¥í•˜ê¸°</button>
        <button onclick="withdrawUser()" class="full-btn btn-danger" style="margin-bottom:10px;">íšŒì› íƒˆí‡´</button>
        <button onclick="toggleEditProfile()" class="full-btn btn-gray">ì·¨ì†Œ</button>
    </div>

    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" onclick="goToPage('main')">
            <i class="ph ph-house"></i>
        </div>
        <div class="nav-item" onclick="goToPage('explore')">
            <i class="ph ph-users"></i>
        </div>
        <div class="nav-item" onclick="goToPage('noti')">
            <i class="ph ph-bell"></i>
            <div id="noti-badge" class="nav-badge">0</div>
        </div>
        <div class="nav-item" onclick="goToPage('dm')">
            <i class="ph ph-paper-plane-right"></i>
            <div id="dm-badge" class="nav-badge">0</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, setDoc, updateDoc, increment, deleteDoc, where, getDocs, deleteField, limit, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ==========================================
        // [ì„¤ì •] ë³¸ì¸ firebaseConfig ë¶™ì—¬ë„£ê¸°
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyABbDbOIrcNq-2SalkWsVRlFZRrPWXu0Sw", 
            authDomain: "my-twitter-commu.firebaseapp.com",
            projectId: "my-twitter-commu",
            storageBucket: "my-twitter-commu.firebasestorage.app",
            messagingSenderId: "612531867322",
            appId: "1:612531867322:web:c56e42c09d060d4a2fbc83"
        };
        // ==========================================

        const ADMIN_EMAIL = "yw3016@naver.com"; // ê´€ë¦¬ì ì´ë©”ì¼

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const MAX_STORAGE_BYTES = 150 * 1024 * 1024;

        let currentUserData = { usedStorage: 0 };
        let selectedFiles = []; let selectedReplyFiles = [];
        let selectedProfileFile = null;
        let isSignupMode = false;
        let currentChatId = null; let currentTargetUid = null; let unsubscribeChat = null; 
        let myUnreadMap = {}; let allUsersCache = {}; let tweetSnapshotCache = null;
        let currentReplyParentId = null; let currentReplyParentUid = null;
        let currentGalleryImages = []; let currentGalleryIndex = 0;
        let allTweetsMap = {};
        let currentProfileUid = null;

        // [NEW] ë‚´ í”„ë¡œí•„ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        window.goToMyProfile = () => {
            if (auth.currentUser) {
                goToUserProfile(auth.currentUser.uid);
            }
        }

        window.updateCharCount = (textarea) => {
            const count = textarea.value.length;
            const counter = document.getElementById('charCount');
            counter.innerText = `${count}/300`;
            if (count > 300) counter.classList.add('warning'); else counter.classList.remove('warning');
        }
        // [NEW] ë‹µê¸€ ì¹´ìš´í„°
        window.updateReplyCharCount = (textarea) => {
            const count = textarea.value.length;
            const counter = document.getElementById('replyCharCount');
            counter.innerText = `${count}/300`;
            if (count > 300) counter.classList.add('warning'); else counter.classList.remove('warning');
        }

        window.onscroll = () => {
            const btn = document.getElementById("scrollTopBtn");
            if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
        };
        window.scrollToTop = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); };

        window.toggleTheme = () => {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            if (current === 'light') {
                body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
            toggleUserMenu(); 
        };
        if (localStorage.getItem('theme') === 'light') { document.body.setAttribute('data-theme', 'light'); }

        window.toggleUserMenu = () => { const menu = document.getElementById('user-menu-dropdown'); menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; };
        window.logout = () => { signOut(auth).then(() => { window.location.reload(); }); };

        window.openImageModal = (images, startIndex) => {
            currentGalleryImages = images; currentGalleryIndex = startIndex;
            document.getElementById('image-modal').style.display = "flex";
            updateModalImage();
        }
        function updateModalImage() {
            const img = document.getElementById('modal-img');
            const counter = document.getElementById('modal-counter');
            img.src = currentGalleryImages[currentGalleryIndex];
            if(currentGalleryImages.length > 1) {
                counter.style.display = 'block'; counter.innerText = `${currentGalleryIndex + 1} / ${currentGalleryImages.length}`;
                document.querySelector('.prev-btn').style.display = 'block'; document.querySelector('.next-btn').style.display = 'block';
            } else { counter.style.display = 'none'; document.querySelector('.prev-btn').style.display = 'none'; document.querySelector('.next-btn').style.display = 'none'; }
        }
        window.changeImage = (step) => {
            let n = currentGalleryIndex + step;
            if (n < 0) n = currentGalleryImages.length - 1; if (n >= currentGalleryImages.length) n = 0;
            currentGalleryIndex = n; updateModalImage();
        }
        window.closeImageModal = () => document.getElementById('image-modal').style.display = "none";

        const allUsersQuery = query(collection(db, "users"));
        onSnapshot(allUsersQuery, (snapshot) => {
            snapshot.forEach(doc => { allUsersCache[doc.id] = doc.data(); });
            if(tweetSnapshotCache) renderTimeline(tweetSnapshotCache);
        });

        onAuthStateChanged(auth, async (user) => {
            const authBtns = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const inputBox = document.getElementById('tweetInputArea');
            const bottomNav = document.getElementById('bottomNav');
            const loginGuide = document.getElementById('login-guide');
            const tweetList = document.getElementById('tweet-list');

            if (user) {
                // ë¡œê·¸ì¸ ì‹œ ìŠ¹ì¸ ì²´í¬
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                
                if (docSnap.exists() && !docSnap.data().isApproved && user.email !== ADMIN_EMAIL) {
                    alert("ê´€ë¦¬ìì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.");
                    await signOut(auth);
                    return;
                }

                // ì‹ ê·œ ê°€ì…ì ì´ˆê¸°í™”
                if (!docSnap.exists()) {
                    const isApproved = (user.email === ADMIN_EMAIL); // ê´€ë¦¬ìë©´ ë°”ë¡œ ìŠ¹ì¸
                    await setDoc(userRef, { email: user.email, name: user.displayName, photoURL: user.photoURL, usedStorage: 0, bio: "", unread: {}, handle: user.email.split('@')[0], website: "", isApproved: isApproved });
                    if (!isApproved) {
                        alert("ê°€ì… ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.");
                        await signOut(auth);
                        return;
                    }
                }

                authBtns.style.display = 'none'; userInfo.style.display = 'flex'; inputBox.style.display = 'block'; bottomNav.style.display = 'flex';
                loginGuide.style.display = 'none'; tweetList.style.display = 'block';

                document.getElementById('userNameDisplay').innerText = user.displayName;
                document.getElementById('myProfileSmall').src = user.photoURL ? user.photoURL : "https://via.placeholder.com/40";
                
                // [NEW] ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ
                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-menu-item').style.display = 'block';
                } else {
                    document.getElementById('admin-menu-item').style.display = 'none';
                }
                
                onSnapshot(userDocRef, (doc) => { 
                    if(doc.exists()) { 
                        currentUserData = doc.data(); 
                        document.getElementById('userHandleDisplay').innerText = "@" + (currentUserData.handle || "unknown");
                        myUnreadMap = currentUserData.unread || {}; 
                        updateBadgeUI(); 
                    } 
                });
                loadNotifications(user.uid);
            } else {
                authBtns.style.display = 'block'; userInfo.style.display = 'none'; inputBox.style.display = 'none'; bottomNav.style.display = 'none';
                loginGuide.style.display = 'block'; tweetList.style.display = 'none';
                goToPage('main');
            }
        });

        const q = query(collection(db, "tweets"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => { tweetSnapshotCache = snapshot; renderTimeline(snapshot); });

        // --- ê´€ë¦¬ì ê¸°ëŠ¥ ---
        window.goToAdminPage = () => {
            if (auth.currentUser.email !== ADMIN_EMAIL) return alert("ê¶Œí•œ ì—†ìŒ");
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('admin-page').classList.add('active');
            loadAdminUserList(); toggleUserMenu();
        }
        
        async function loadAdminUserList() {
            const listDiv = document.getElementById('admin-user-list');
            listDiv.innerHTML = "ë¡œë”© ì¤‘...";
            const usersSnap = await getDocs(collection(db, "users"));
            listDiv.innerHTML = "";
            usersSnap.forEach(doc => {
                const data = doc.data();
                if (data.email === ADMIN_EMAIL) return;
                const status = data.isApproved ? "" : "(ëŒ€ê¸°ì¤‘)";
                const btnHtml = data.isApproved 
                    ? `<button class="delete-user-btn" onclick="adminDeleteUser('${doc.id}')">ê°•ì œ íƒˆí‡´</button>` 
                    : `<button class="approve-btn" onclick="approveUser('${doc.id}')">ìŠ¹ì¸</button>`;
                const html = `<div class="user-list-item"><div style="display:flex; align-items:center;"><img src="${data.photoURL || 'https://via.placeholder.com/40'}" class="user-list-img"><div><div class="user-name-bold">${data.name} ${status}</div><div style="font-size:12px; color:var(--text-sub);">${data.email}</div></div></div>${btnHtml}</div>`;
                listDiv.insertAdjacentHTML('beforeend', html);
            });
        }

        window.approveUser = async (uid) => {
            if(!confirm("ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await updateDoc(doc(db, "users", uid), { isApproved: true });
            alert("ìŠ¹ì¸ë¨"); loadAdminUserList();
        }

        window.adminDeleteUser = async (uid) => {
            if(!confirm("ê°•ì œ íƒˆí‡´? (ë³µêµ¬ ë¶ˆê°€)")) return;
            await deleteUserData(uid);
            alert("ì‚­ì œë¨"); loadAdminUserList();
        }

        async function deleteUserData(uid) {
            const tweetsQ = query(collection(db, "tweets"), where("uid", "==", uid));
            const tweetsSnap = await getDocs(tweetsQ);
            tweetsSnap.forEach(async (d) => { const data = d.data(); if (data.imageUrls) { data.imageUrls.forEach(url => deleteObject(ref(storage, url)).catch(()=>{})); } await deleteDoc(d.ref); });
            try { await deleteObject(ref(storage, `profiles/${uid}`)); } catch(e) {}
            await deleteDoc(doc(db, "users", uid));
        }

        window.withdrawUser = async () => {
            if(!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const user = auth.currentUser; const uid = user.uid;
            try { await deleteUserData(uid); await deleteUser(user); alert("íƒˆí‡´ ì™„ë£Œ"); window.location.reload(); } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        }

        function loadNotifications(uid) {
            const notiQuery = query(collection(db, "notifications"), where("toUid", "==", uid));
            onSnapshot(notiQuery, (snapshot) => {
                const list = document.getElementById('noti-list'); const badge = document.getElementById('noti-badge');
                list.innerHTML = ""; let unreadCount = 0;
                if(snapshot.empty) { list.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub)'>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; badge.style.display = 'none'; return; }
                let notis = [];
                snapshot.forEach(doc => notis.push({ id: doc.id, ...doc.data() }));
                notis.sort((a, b) => b.createdAt.localeCompare(a.createdAt));

                notis.forEach(data => {
                    if(!data.read) unreadCount++;
                    const sender = allUsersCache[data.fromUid] || {name: "ì•Œ ìˆ˜ ì—†ìŒ"};
                    const time = new Date(data.createdAt).toLocaleDateString();
                    const readClass = data.read ? "" : "unread";
                    let msg = ""; let icon = "ğŸ’¬";
                    let preview = data.content;
                    if (!preview || preview.trim() === "") { if (data.type === 'reply') preview = "ì‚¬ì§„"; else preview = ""; }
                    if (data.type === 'reply') msg = `<strong>${sender.name}</strong>ë‹˜ì´ ë‹µê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤.`;
                    else if (data.type === 'mention') { msg = `<strong>${sender.name}</strong>ë‹˜ì´ íšŒì›ë‹˜ì„ ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤.`; icon = "ğŸ””"; }
                    const html = `<div class="notification-item ${readClass}" onclick="readNotification('${data.id}', '${data.tweetId}')"><span class="noti-icon">${icon}</span><div style="flex:1; overflow:hidden;"><div>${msg}</div><div class="noti-preview">${preview}</div><div style="font-size:11px; color:var(--text-sub); margin-top:4px;">${time}</div></div></div>`;
                    list.insertAdjacentHTML('beforeend', html);
                });
                if(unreadCount > 0) { badge.style.display = 'block'; badge.innerText = unreadCount; } else { badge.style.display = 'none'; }
            });
        }
        window.readNotification = async (notiId, tweetId) => {
            await updateDoc(doc(db, "notifications", notiId), { read: true });
            if(tweetId) goToTweetDetail(tweetId); 
        }

        window.toggleKeep = async (tweetId) => {
            const user = auth.currentUser;
            if(!user) return alert("ë¡œê·¸ì¸ í•„ìš”");
            const tweetRef = doc(db, "tweets", tweetId);
            const docSnap = await getDoc(tweetRef);
            if(docSnap.exists()) {
                const data = docSnap.data();
                const keptBy = data.keptBy || [];
                if(keptBy.includes(user.uid)) {
                    await updateDoc(tweetRef, { keptBy: arrayRemove(user.uid) });
                } else {
                    await updateDoc(tweetRef, { keptBy: arrayUnion(user.uid) });
                }
            }
        }

        // [NEW] ì¬ê·€ì  ë‹µê¸€ ê°€ì ¸ì˜¤ê¸° (Deep Thread Fetch)
        async function fetchAllReplies(tweetId) {
            let replies = [];
            const q = query(collection(db, "tweets"), where("parentId", "==", tweetId));
            const snap = await getDocs(q);
            
            for (const doc of snap.docs) {
                const reply = { id: doc.id, ...doc.data() };
                // ì¬ê·€ì ìœ¼ë¡œ ê·¸ ì•„ë˜ ë‹µê¸€ë“¤ë„ ê°€ì ¸ì˜´
                reply.replies = await fetchAllReplies(reply.id);
                replies.push(reply);
            }
            // ë‚ ì§œìˆœ ì •ë ¬
            replies.sort((a, b) => a.date.localeCompare(b.date));
            return replies;
        }

        // [MODIFIED] ìƒì„¸ í˜ì´ì§€ ë¡œì§ (ë¬´í•œ ê¹Šì´ ì§€ì›)
        window.goToTweetDetail = async (tweetId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('detail-page').classList.add('active');
            const detailFeed = document.getElementById('detail-feed');
            detailFeed.innerHTML = "<div style='padding:20px; text-align:center; color:var(--text-sub)'>ë¡œë”© ì¤‘...</div>";
            
            try {
                const docRef = doc(db, "tweets", tweetId);
                const docSnap = await getDoc(docRef);
                if(!docSnap.exists()) { detailFeed.innerHTML = "<div style='padding:20px; text-align:center; color:var(--text-sub)'>ì‚­ì œëœ íŠ¸ìœ—ì…ë‹ˆë‹¤.</div>"; return; }
                
                const currentTweet = { id: docSnap.id, ...docSnap.data() };
                
                // 1. ì¡°ìƒ(Ancestors) ì°¾ê¸°
                let ancestors = [];
                let parentId = currentTweet.parentId;
                while (parentId) {
                    const pDoc = await getDoc(doc(db, "tweets", parentId));
                    if (pDoc.exists()) { ancestors.unshift({ id: pDoc.id, ...pDoc.data() }); parentId = pDoc.data().parentId; } 
                    else { ancestors.unshift({ isDeleted: true, id: "deleted" }); break; }
                    if(ancestors.length > 5) break; 
                }

                // 2. ìì†(Descendants) ì°¾ê¸° - ì „ì²´ íŠ¸ë¦¬
                const descendants = await fetchAllReplies(tweetId);

                // 3. ë Œë”ë§
                detailFeed.innerHTML = "";
                
                // ì¡°ìƒ
                ancestors.forEach((t, i) => {
                    const isLastAncestor = (i === ancestors.length - 1);
                    // ì¡°ìƒë“¤ì€ ì•„ë˜ë¡œ ì—°ê²°ë¨
                    detailFeed.insertAdjacentHTML('beforeend', createTweetHTML(t, t.id, false, false, 'root', true)); 
                });

                // ì£¼ì¸ê³µ
                const isMine = auth.currentUser && currentTweet.uid === auth.currentUser.uid;
                // ì£¼ì¸ê³µì€ ìì‹ì´ ìˆìœ¼ë©´ ì•„ë˜ë¡œ ì—°ê²°ë¨
                const hasChildren = descendants.length > 0;
                detailFeed.insertAdjacentHTML('beforeend', createTweetHTML(currentTweet, currentTweet.id, isMine, true, 'main', hasChildren));

                // ìì† (ì¬ê·€ì  ë Œë”ë§ + ë”ë³´ê¸°)
                renderDescendants(descendants, detailFeed, 0);

            } catch(e) { detailFeed.innerHTML = "ì˜¤ë¥˜ ë°œìƒ: " + e.message; }
        }

        // [MODIFIED] ìì† ë Œë”ë§ í•¨ìˆ˜ (ê¹Šì´ ì œí•œ ë“¤ì—¬ì“°ê¸°)
        function renderDescendants(replies, container, depth) {
            const limitCount = 10;
            const visibleReplies = replies.slice(0, limitCount);
            const hiddenReplies = replies.slice(limitCount);

            visibleReplies.forEach(t => {
                const isMine = auth.currentUser && t.uid === auth.currentUser.uid;
                const hasChildren = t.replies && t.replies.length > 0;
                
                const groupDiv = document.createElement("div");
                groupDiv.className = "thread-group";
                
                // [í•µì‹¬ ìˆ˜ì •] ê¹Šì´ ì œí•œ (ìµœëŒ€ 3ë‹¨ê³„ê¹Œì§€ë§Œ ë“¤ì—¬ì“°ê¸°)
                const safeDepth = Math.min(depth, 3);
                groupDiv.style.marginLeft = (safeDepth * 20) + "px"; 
                groupDiv.style.borderLeft = "2px solid var(--border-color)";
                
                groupDiv.insertAdjacentHTML('beforeend', createTweetHTML(t, t.id, isMine, false, 'single', hasChildren));
                container.appendChild(groupDiv);
                
                if(hasChildren) {
                    renderDescendants(t.replies, container, depth + 1);
                }
            });

            if (hiddenReplies.length > 0) {
                const btnId = `more-btn-${Date.now()}-${depth}`;
                const divId = `hidden-div-${Date.now()}-${depth}`;
                const btnHtml = `<button id="${btnId}" class="load-more-thread-btn" onclick="document.getElementById('${divId}').style.display='block'; this.style.display='none';">â• ë‹µê¸€ ${hiddenReplies.length}ê°œ ë” ë³´ê¸°</button>`;
                container.insertAdjacentHTML('beforeend', btnHtml);
                const hiddenDiv = document.createElement('div');
                hiddenDiv.id = divId;
                hiddenDiv.className = 'hidden-thread-item';
                container.appendChild(hiddenDiv);
                
                hiddenReplies.forEach(t => {
                    const isMine = auth.currentUser && t.uid === auth.currentUser.uid;
                    const hasChildren = t.replies && t.replies.length > 0;
                    hiddenDiv.insertAdjacentHTML('beforeend', createTweetHTML(t, t.id, isMine, false, 'single', hasChildren));
                    if(hasChildren) renderDescendants(t.replies, hiddenDiv, depth + 1);
                });
            }
        }

        function renderTimeline(snapshot) {
            const list = document.getElementById('tweet-list'); list.innerHTML = "";
            const me = auth.currentUser;
            allTweetsMap = {};
            snapshot.forEach(doc => { allTweetsMap[doc.id] = { id: doc.id, ...doc.data() }; });

            snapshot.forEach((doc) => {
                const data = doc.data();
                const isMine = me && (data.uid === me.uid);
                
                if (data.parentId) {
                    const rootTweet = findRoot(data.parentId);
                    if (rootTweet) {
                        const rootHtml = createTweetHTML(rootTweet, rootTweet.id, false, false, 'root', true);
                        const mainHtml = createTweetHTML(data, doc.id, isMine, false, 'main', false);
                        const threadHtml = `<div class="thread-group">${rootHtml}<div class="thread-connector"></div>${mainHtml}</div>`;
                        list.insertAdjacentHTML('beforeend', threadHtml);
                    } else {
                        list.insertAdjacentHTML('beforeend', createTweetHTML(data, doc.id, isMine, false, 'single', false));
                    }
                } else {
                    list.insertAdjacentHTML('beforeend', createTweetHTML(data, doc.id, isMine, false, 'single', false));
                }
            });
        }

        function findRoot(parentId) {
            const parent = allTweetsMap[parentId];
            if (!parent) return null;
            if (!parent.parentId) return parent;
            return findRoot(parent.parentId);
        }

        // [MODIFIED] HTML ìƒì„± í•¨ìˆ˜: ì—°ê²°ì„  ë¡œì§ ì¶”ê°€
        function createTweetHTML(data, id, isMine, isFocus, type='single', isConnectedBottom=false) {
            if (data.isDeleted) return `<div class="tweet deleted"><div class="content"><p>ğŸ—‘ ì‚­ì œëœ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.</p></div></div>`;
            
            let timeString = data.date ? new Date(data.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";
            const authorLatest = allUsersCache[data.uid] || { name: data.name, handle: "unknown", photoURL: data.profilePic };
            const latestName = authorLatest.name;
            const latestHandle = authorLatest.handle || "unknown";
            const latestPhoto = authorLatest.photoURL || data.profilePic;
            const imgStyle = latestPhoto ? `background-image: url(${latestPhoto});` : `background-color: var(--bg-sub);`;
            
            let imageHtml = "";
            let images = data.imageUrls || (data.imageUrl ? [data.imageUrl] : []);
            const urlsEscaped = JSON.stringify(images).replace(/"/g, '&quot;');
            if (images.length > 0) {
                const gridClass = `grid-${Math.min(images.length, 4)}`;
                let imgs = "";
                images.forEach((url, i) => { imgs += `<img src="${url}" class="tweet-img-item" onclick='openImageModal(${urlsEscaped}, ${i}); event.stopPropagation();'>`; });
                imageHtml = `<div class="tweet-img-grid ${gridClass}">${imgs}</div>`;
            }

            const deleteBtn = isMine ? `<button class="delete-btn" onclick="deleteTweet('${id}', '${urlsEscaped}', ${data.imageSize || 0}); event.stopPropagation();">â‹®</button>` : "";
            
            let typeClass = "";
            if (type === 'root') typeClass = "root-node";
            else if (type === 'main') typeClass = "main-node";
            else if (type === 'single') typeClass = "single";
            
            const connectedClass = isConnectedBottom ? "has-child" : "";

            const focusClass = isFocus ? 'focus-tweet' : '';
            const clickAction = isFocus ? '' : `onclick="goToTweetDetail('${id}')"`;

            let safeContent = data.content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            safeContent = safeContent.replace(/@(\w+)/g, '<span class="mention-tag">@$1</span>');

            const keptBy = data.keptBy || [];
            const keepCount = keptBy.length;
            const myUid = auth.currentUser ? auth.currentUser.uid : null;
            const isKept = myUid && keptBy.includes(myUid);
            const keepClass = isKept ? "active-keep" : "";
            const keepIconWeight = isKept ? "fill" : "regular";

            let lineHtml = "";
            if (type === 'root') lineHtml = `<div class="thread-line-down" style="display:block"></div>`;
            if (type === 'main') lineHtml = `<div class="thread-line-up" style="display:block"></div>`; 
            if (type === 'child') lineHtml = `<div class="thread-line-up" style="display:block"></div>` + (isConnectedBottom ? `<div class="thread-line-down" style="display:block"></div>` : "");

            return `
                <div class="tweet ${typeClass} ${focusClass} ${connectedClass}" ${clickAction}>
                    <div class="tweet-left">
                        <div class="profile-pic" style="${imgStyle} background-size: cover;"></div>
                        ${lineHtml}
                    </div>
                    <div class="content">
                        <h4>${latestName} <span class="user-handle">@${latestHandle}</span> <span class="time">Â· ${timeString}</span></h4>
                        <p>${safeContent}</p>
                        ${imageHtml}
                        <div class="tweet-actions">
                            <button class="action-btn" onclick="openReplyModal('${id}', '${latestHandle}', '${data.uid}'); event.stopPropagation();">ğŸ’¬ ë‹µê¸€</button>
                            <button class="action-btn ${keepClass}" onclick="toggleKeep('${id}'); event.stopPropagation();">
                                <i class="ph-${keepIconWeight} ph-hand-palm" style="font-size:18px;"></i> ${keepCount > 0 ? keepCount : ''}
                            </button>
                        </div>
                    </div>
                    ${deleteBtn}
                </div>`;
        }

        async function processMentionsAndNotify(text, tweetId, senderUid) {
            const regex = /@(\w+)/g;
            let match;
            const mentionedHandles = [];
            while ((match = regex.exec(text)) !== null) { mentionedHandles.push(match[1]); }
            if (mentionedHandles.length === 0) return;
            const userIds = Object.keys(allUsersCache);
            userIds.forEach(async (uid) => {
                const u = allUsersCache[uid];
                if (u.handle && mentionedHandles.includes(u.handle) && uid !== senderUid) {
                    await addDoc(collection(db, "notifications"), { 
                        toUid: uid, fromUid: senderUid, type: 'mention', 
                        tweetId: tweetId, read: false, createdAt: new Date().toISOString(),
                        content: text 
                    });
                }
            });
        }

        window.openReplyModal = (tweetId, handle, userUid) => {
            if(!auth.currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
            currentReplyParentId = tweetId; currentReplyParentUid = userUid;
            document.getElementById('reply-target-name').innerText = "@" + handle;
            document.getElementById('reply-modal').style.display = 'block';
            document.getElementById('replyCharCount').innerText = "0/300"; // ë¦¬ì…‹
        }
        window.closeReplyModal = () => { document.getElementById('reply-modal').style.display = 'none'; document.getElementById('replyMsg').value = ""; removeReplyImages(); }

        window.submitReply = async () => {
            const text = document.getElementById('replyMsg').value;
            const user = auth.currentUser;
            if(!text && selectedReplyFiles.length === 0) return;
            if(text.length > 300) return alert("300ìë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.");
            
            const btn = document.getElementById('replySubmitBtn'); btn.disabled = true; btn.innerText = "...";
            try {
                let imageUrls = []; let totalSize = selectedReplyFiles.reduce((acc, f) => acc + f.size, 0);
                if (selectedReplyFiles.length > 0) {
                    const uploadPromises = selectedReplyFiles.map(async (file) => { const snap = await uploadBytes(ref(storage, 'images/' + Date.now() + '_' + user.uid), file); return getDownloadURL(snap.ref); });
                    imageUrls = await Promise.all(uploadPromises);
                    await updateDoc(doc(db, "users", user.uid), { usedStorage: increment(totalSize) });
                }
                const docRef = await addDoc(collection(db, "tweets"), {
                    content: text, imageUrls: imageUrls, imageSize: totalSize, date: new Date().toISOString(), name: user.displayName, profilePic: user.photoURL, uid: user.uid,
                    parentId: currentReplyParentId, parentName: document.getElementById('reply-target-name').innerText.replace("@", ""),
                    keptBy: [] 
                });

                if (user.uid !== currentReplyParentUid) {
                    await addDoc(collection(db, "notifications"), { 
                        toUid: currentReplyParentUid, fromUid: user.uid, type: 'reply', 
                        tweetId: currentReplyParentId, read: false, createdAt: new Date().toISOString(),
                        content: text 
                    });
                }
                await processMentionsAndNotify(text, docRef.id, user.uid);
                closeReplyModal();
                if(document.getElementById('detail-page').classList.contains('active')) goToTweetDetail(currentReplyParentId);
            } catch(e) { console.error(e); alert("ì‹¤íŒ¨"); } finally { btn.disabled = false; btn.innerText = "ë‹µê¸€"; }
        }

        window.addTweet = async () => {
            const input = document.getElementById('tweetMsg');
            const text = input.value;
            const user = auth.currentUser;
            if (!user) return alert("ë¡œê·¸ì¸ í•„ìš”");
            if (text === "" && selectedFiles.length === 0) return;
            if(text.length > 300) return alert("300ìë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.");

            let totalSize = selectedFiles.reduce((acc, f) => acc + f.size, 0);
            if ((currentUserData.usedStorage || 0) + totalSize > MAX_STORAGE_BYTES) return alert("ìš©ëŸ‰ ë¶€ì¡±!");
            const btn = document.getElementById('tweetBtn'); btn.disabled = true; btn.innerText = "...";
            try {
                let imageUrls = [];
                if (selectedFiles.length > 0) {
                    const promises = selectedFiles.map(async (file) => { const snap = await uploadBytes(ref(storage, 'images/' + Date.now() + '_' + user.uid), file); return getDownloadURL(snap.ref); });
                    imageUrls = await Promise.all(promises);
                    await updateDoc(doc(db, "users", user.uid), { usedStorage: increment(totalSize) });
                }
                const docRef = await addDoc(collection(db, "tweets"), {
                    content: text, imageUrls: imageUrls, imageSize: totalSize, date: new Date().toISOString(), name: user.displayName, profilePic: user.photoURL, uid: user.uid,
                    keptBy: [] 
                });
                await processMentionsAndNotify(text, docRef.id, user.uid);
                input.value = ""; removeImages();
                document.getElementById('charCount').innerText = "0/300";
            } catch(e) { console.error(e); } finally { btn.disabled = false; btn.innerText = "íŠ¸ìœ—í•˜ê¸°"; }
        }

        window.handleFileSelect = (input) => handleFiles(input, 'preview-grid', 'preview-box', (files) => selectedFiles = files);
        window.handleReplyFileSelect = (input) => handleFiles(input, 'reply-preview-grid', 'reply-preview-box', (files) => selectedReplyFiles = files);
        function handleFiles(input, gridId, boxId, setFiles) {
            if (input.files) { if(input.files.length > 4) { alert("ìµœëŒ€ 4ì¥"); return; } const files = Array.from(input.files); setFiles(files); const grid = document.getElementById(gridId); grid.innerHTML = ""; grid.className = `preview-grid grid-${files.length}`; files.forEach(file => { const reader = new FileReader(); reader.onload = (e) => grid.insertAdjacentHTML('beforeend', `<img src="${e.target.result}" class="preview-img">`); reader.readAsDataURL(file); }); document.getElementById(boxId).style.display = 'block'; }
        }
        window.removeImages = () => { selectedFiles = []; document.getElementById('file-input').value = ""; document.getElementById('preview-box').style.display = 'none'; }
        window.removeReplyImages = () => { selectedReplyFiles = []; document.getElementById('reply-file-input').value = ""; document.getElementById('reply-preview-box').style.display = 'none'; }
        
        window.deleteTweet = async (docId, urlsString, imageSize) => {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                let images = []; try { images = JSON.parse(urlsString); } catch(e) { if(urlsString && urlsString !== "[]") images = [urlsString]; }
                if (images.length > 0) { images.forEach(async (url) => { try { await deleteObject(ref(storage, url)); } catch(e){} }); }
                const user = auth.currentUser;
                if(user && imageSize > 0) await updateDoc(doc(db, "users", user.uid), { usedStorage: increment(-imageSize) });
                await updateDoc(doc(db, "tweets", docId), { isDeleted: true, content: "", imageUrls: [], imageSize: 0 });
                if(document.getElementById('detail-page').classList.contains('active')) goToPage('main');
                alert("ì‚­ì œë¨");
            } catch(e) { console.error(e); }
        }
        function updateBadgeUI() { let totalUnread = 0; for(const k in myUnreadMap) totalUnread += myUnreadMap[k]; const badge = document.getElementById('dm-badge'); if(totalUnread > 0) { badge.style.display = 'block'; badge.innerText = totalUnread > 99 ? '99+' : totalUnread; } else badge.style.display = 'none'; }
        function updateStorageUI(add) { const curr = currentUserData.usedStorage || 0; const pct = Math.min(((curr + add) / MAX_STORAGE_BYTES) * 100, 100); }
        
        window.goToPage = (pageName) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(pageName === 'main') { 
                document.getElementById('main-page').classList.add('active'); 
                document.querySelector('.nav-item:nth-child(1)').classList.add('active'); 
            }
            else if(pageName === 'explore') { 
                document.getElementById('explore-page').classList.add('active'); 
                loadAllUsersForExplore(); 
                document.querySelector('.nav-item:nth-child(2)').classList.add('active'); 
            }
            else if(pageName === 'noti') { 
                document.getElementById('noti-page').classList.add('active'); 
                document.querySelector('.nav-item:nth-child(3)').classList.add('active'); 
            }
            else if(pageName === 'dm') { 
                document.getElementById('dm-page').classList.add('active'); loadAllChatList(); // [DM] ë¡œë“œ í•¨ìˆ˜ ì—°ê²°
                document.querySelector('.nav-item:nth-child(4)').classList.add('active'); 
            }
            else if(pageName === 'profile') { goToMyProfile(); }
        }
        window.toggleAuth = (m) => {
            const f = document.getElementById('auth-form'); 
            if(m === 'close') { f.style.display = 'none'; return; }
            f.style.display = 'block'; isSignupMode = (m === 'signup');
            document.getElementById('auth-title').innerText = isSignupMode ? "íšŒì›ê°€ì…" : "ë¡œê·¸ì¸";
            document.getElementById('nickNameInput').style.display = isSignupMode ? 'block' : 'none';
            document.getElementById('handleInput').style.display = isSignupMode ? 'block' : 'none';
        }
        
        async function loadAllUsers() {
            /* (ê¸°ì¡´ 1:1 í•¨ìˆ˜ - ì´ì   ì•ˆ ì”€. loadAllChatListê°€ ëŒ€ì²´) */
        }

        async function loadAllUsersForExplore() {
            const listDiv = document.getElementById('explore-user-list'); 
            listDiv.innerHTML = "";
            const userIds = Object.keys(allUsersCache);
            userIds.forEach(uid => {
                const data = allUsersCache[uid]; 
                const img = data.photoURL ? data.photoURL : "https://via.placeholder.com/40";
                const handle = data.handle ? "@" + data.handle : "";
                const html = `
                    <div class="user-list-item" onclick="goToUserProfile('${uid}')">
                        <div style="display:flex; align-items:center;">
                            <img src="${img}" class="user-list-img">
                            <div>
                                <div class="user-name-bold">${data.name}</div>
                                <div style="font-size:12px; color:var(--text-sub);">${handle}</div>
                            </div>
                        </div>
                    </div>`; 
                listDiv.insertAdjacentHTML('beforeend', html);
            });
        }
        
        document.getElementById('submitAuthBtn').addEventListener('click', async () => {
            const e = document.getElementById('emailInput').value; const p = document.getElementById('pwInput').value; const n = document.getElementById('nickNameInput').value;
            const h = document.getElementById('handleInput').value;
            try { 
                if (isSignupMode) { 
                    if(!h) return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    const q = query(collection(db, "users"), where("handle", "==", h));
                    const snapshot = await getDocs(q);
                    if(!snapshot.empty) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");

                    const r = await createUserWithEmailAndPassword(auth, e, p); 
                    await updateProfile(r.user, { displayName: n });
                    await setDoc(doc(db, "users", r.user.uid), { email: e, name: n, handle: h, photoURL: null, usedStorage: 0, bio: "", unread: {}, website: "" });
                    alert("ê°€ì…ì™„ë£Œ"); 
                } else { 
                    await signInWithEmailAndPassword(auth, e, p); 
                    alert("ë¡œê·¸ì¸ì™„ë£Œ"); 
                } 
                document.getElementById('auth-form').style.display = 'none'; 
            } catch (er) { alert("ì—ëŸ¬: " + er.message); }
        });
    </script>
</body>
</html>
